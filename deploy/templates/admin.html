{% extends "layout.html" %}

{% block title %}Admin - Scenario Manager{% endblock %}

{% block body %}
<div class="canvas">
    <header class="stage-header">
        <h1>Scenario Manager</h1>
        <p>Configure different draw events and email templates.</p>
        <a href="/" style="color: #cbd5e1; text-decoration: none;">&larr; Back to Draw</a>
    </header>

    <div class="control-panel" style="text-align: left; max-width: 800px; margin: 0 auto;">
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
            <select id="scenarioSelect" style="flex: 1; padding: 0.5rem; border-radius: 8px;">
                <option value="">-- Select Scenario to Edit --</option>
            </select>
            <button id="newScenarioBtn" class="big-red-button" style="font-size: 1rem; padding: 0.5rem 1.5rem;">New</button>
            <button id="deleteScenarioBtn" class="big-red-button" style="font-size: 1rem; padding: 0.5rem 1.5rem; background: #64748b;">Delete</button>
        </div>

        <form id="scenarioForm" style="display: none;">
            <input type="hidden" id="scenarioId">
            
            <div style="margin-bottom: 1rem;">
                <label style="color: white; display: block; margin-bottom: 0.5rem;">Scenario Name</label>
                <input type="text" id="scenarioName" style="width: 100%; padding: 0.5rem; border-radius: 8px;" required>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="color: white; display: block; margin-bottom: 0.5rem;">Email Subject</label>
                <input type="text" id="scenarioSubject" style="width: 100%; padding: 0.5rem; border-radius: 8px;" required>
                <small style="color: #cbd5e1;">Available variables: {scenario_name}</small>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="color: white; display: block; margin-bottom: 0.5rem;">Email Body (HTML)</label>
                <textarea id="scenarioBody" rows="10" style="width: 100%; padding: 0.5rem; border-radius: 8px; font-family: monospace;" required></textarea>
                <small style="color: #cbd5e1;">Available variables: {drawer_name}, {encoded_name}, {reveal_link}</small>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="color: white; display: block; margin-bottom: 0.5rem;">Participants</label>
                <div id="participantsList" style="background: white; padding: 1rem; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                    <!-- Checkboxes injected here -->
                </div>
            </div>

            <button type="submit" class="big-red-button" style="width: 100%;">Save Scenario</button>
        </form>
    </div>
</div>

<script>
let scenarios = [];
let allParticipants = [];

async function init() {
    const [sRes, pRes] = await Promise.all([
        fetch('/api/scenarios'),
        fetch('/api/participants')
    ]);
    
    scenarios = (await sRes.json()).scenarios;
    allParticipants = (await pRes.json()).participants;
    
    renderSelect();
    renderParticipants();
}

function renderSelect() {
    const select = document.getElementById('scenarioSelect');
    select.innerHTML = '<option value="">-- Select Scenario to Edit --</option>';
    scenarios.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        select.appendChild(opt);
    });
}

function renderParticipants() {
    const container = document.getElementById('participantsList');
    container.innerHTML = '';
    allParticipants.forEach(p => {
        const div = document.createElement('div');
        div.style.marginBottom = '0.5rem';
        div.innerHTML = `
            <label style="color: #1e293b; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" value="${p.name}" name="participants">
                ${p.name} <span style="color: #64748b; font-size: 0.8em;">(${p.email})</span>
            </label>
        `;
        container.appendChild(div);
    });
}

document.getElementById('scenarioSelect').addEventListener('change', (e) => {
    const id = e.target.value;
    if (!id) {
        document.getElementById('scenarioForm').style.display = 'none';
        return;
    }
    
    const scenario = scenarios.find(s => s.id === id);
    loadScenario(scenario);
});

document.getElementById('newScenarioBtn').addEventListener('click', () => {
    loadScenario({
        id: crypto.randomUUID(),
        name: 'New Scenario',
        subject: 'Secret Santa Assignment',
        template_body: '',
        participants: allParticipants.map(p => p.name)
    });
});

function loadScenario(scenario) {
    document.getElementById('scenarioForm').style.display = 'block';
    document.getElementById('scenarioId').value = scenario.id;
    document.getElementById('scenarioName').value = scenario.name;
    document.getElementById('scenarioSubject').value = scenario.subject;
    document.getElementById('scenarioBody').value = scenario.template_body;
    
    const checkboxes = document.querySelectorAll('input[name="participants"]');
    checkboxes.forEach(cb => {
        cb.checked = scenario.participants.includes(cb.value);
    });
}

document.getElementById('scenarioForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const selectedParticipants = Array.from(document.querySelectorAll('input[name="participants"]:checked'))
        .map(cb => cb.value);
        
    const scenario = {
        id: document.getElementById('scenarioId').value,
        name: document.getElementById('scenarioName').value,
        subject: document.getElementById('scenarioSubject').value,
        template_body: document.getElementById('scenarioBody').value,
        participants: selectedParticipants
    };
    
    await fetch('/api/scenarios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scenario)
    });
    
    alert('Saved!');
    init(); // Reload
});

document.getElementById('deleteScenarioBtn').addEventListener('click', async () => {
    const id = document.getElementById('scenarioSelect').value;
    if (!id) return;
    
    if (confirm('Are you sure?')) {
        await fetch(`/api/scenarios/${id}`, { method: 'DELETE' });
        document.getElementById('scenarioForm').style.display = 'none';
        init();
    }
});

init();
</script>
{% endblock %}